---
title: "Imputation Techniques Visualization"
author: "Jacopo Zacchigna, Devid Rosa, Cristiano Baldassi, Ludovica Bianchi"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    code_fold: hide # Hidden by default unless specified otherwise
    df_print: paged
    highlight: tango
    theme: flatly
    number_sections: true
    toc_collapsible: true  # Enable collapsible TOC
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
library(here)

# Load utilities
source(here("src", "setup.R"))
```

```{r,  class.source = 'fold-show'}
# Define methods with their display names and corresponding functions
imputation_methods <- list(
  "Mean Imputation" = function(data) { simple_imputation(data, "mean") },
  # Return only necessary collums
  "KNN Imputation" = function(data) {
  # Perform the kNN imputation
  imputed_data <- kNN(data, variable = "x2")
  
  # Remove the column with the '_imp' suffix (e.g., x2_imp)
  imputed_data <- imputed_data[, !grepl("_imp$", colnames(imputed_data))]
  
  # Return the imputed dataset without the '_imp' column
  return(imputed_data)
  },
  "Regression Imputation" = function(data) { regression_imputation(data) },
  "Regression Imputation with Noise" = function(data) { regression_imputation(data, noise = TRUE) },
  "Hot Deck Imputation" = function(data) { hot_deck_imputation(data) },
  "EM Imputation" = function(data) { impute_EM(data) },
  "GAM Imputation" = function(data) { gam_based_imputation(data) },
  "GAM Imputation with Noise" = function(data) { gam_based_imputation(data, noise = TRUE) },
  "Random Forest Imputation" = function(data) { tree_based_imputation(data) }
)
```

# Testing Different Relationships
> Initialize different methods

## Linear Relationship

In a linear relationship, we expect methods like regression imputation to perform well since they can capture the linear pattern in the data.

```{r, fig.width=18, fig.height=14}
# Generate and create missing data
n <- 200
p <- 0.3

linear_data <- generate_data(n, "linear", noise_sd = 0.2)
linear_missing <- delete_MAR_1_to_x(linear_data, p, cols_mis = "x2", cols_ctrl = "x1", x = 10)

# Use the new combined analysis function
linear_result <- plot_imputations_and_metrics(original_data = linear_data, missing_data = linear_missing, imputation_methods = imputation_methods)

# Access the list of individual plots
imputation_plots <- linear_result$imputation_plots

# Arrange and display them as needed
grid.arrange(grobs = imputation_plots, ncol = 2)
```

```{r}
# Access the metrics plot
metrics_plot <- linear_result$metrics_plot
print(metrics_plot)
```

## Quadratic Relationship

For quadratic relationships, we expect more flexible methods like GAM and Random Forest to perform better than simple linear regression.

```{r, fig.width=18, fig.height=14}
# Generate and create missing data
quad_data <- generate_data(n, "quadratic")
quad_missing <- delete_MAR_1_to_x(quad_data, p, cols_mis = "x2", cols_ctrl = "x1", x = 10)

quad_result <- plot_imputations_and_metrics(quad_data, quad_missing, imputation_methods)

# Access the list of individual plots
imputation_plots <- quad_result$imputation_plots

# Arrange and display them as needed
grid.arrange(grobs = imputation_plots, ncol = 2)
```

```{r}
# Access the metrics plot
metrics_plot <- quad_result$metrics_plot
print(metrics_plot)
```

## Cubic Relationship

Cubic relationships are even more complex, highlighting the advantages of more flexible methods.

```{r, fig.width=18, fig.height=14}
# Generate and create missing data
cubic_data <- generate_data(n, "cubic")
cubic_missing <- delete_MAR_1_to_x(cubic_data, p, cols_mis = "x2", cols_ctrl = "x1", x = 10)

cubic_result <- plot_imputations_and_metrics(cubic_data, cubic_missing, imputation_methods)

# Access the list of individual plots
imputation_plots <- cubic_result$imputation_plots

# Arrange and display them as needed
grid.arrange(grobs = imputation_plots, ncol = 2)
```

```{r}
# Access the metrics plot
metrics_plot <- cubic_result$metrics_plot
print(metrics_plot)
```

## Logarithmic Relationship

Logarithmic relationships demonstrate how methods perform with non-linear but monotonic relationships.

```{r, fig.width=18, fig.height=14}
# Generate and create missing data
log_data <- generate_data(n, "log", x_range = c(1, 100))
log_missing <- delete_MAR_1_to_x(log_data, p, cols_mis = "x2", cols_ctrl = "x1", x = 10)

log_result <- plot_imputations_and_metrics(log_data, log_missing, imputation_methods)

# Access the list of individual plots
imputation_plots <- log_result$imputation_plots

# Arrange and display them as needed
grid.arrange(grobs = imputation_plots, ncol = 2)
```

```{r}
# Access the metrics plot
metrics_plot <- log_result$metrics_plot
print(metrics_plot)
```

# Conclusions

The visualizations demonstrate that:

1. Simple mean imputation tends to perform poorly as it ignores the relationship between variables
2. kNN and hot deck methods can work well when there are similar cases nearby
3. Regression imputation works best for linear relationships
4. GAM and Random Forest methods are more flexible and can handle non-linear relationships better
5. The choice of imputation method should depend on the underlying relationship between variables

# References

- Zhang Z. Missing data imputation: focusing on single imputation. Ann Transl Med. 2016 Jan;4(1):9. doi: 10.3978/j.issn.2305-5839.2015.12.38. PMID: 26855945; PMCID: PMC4716933.